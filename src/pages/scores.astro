---
import BaseLayout from "../layouts/BaseLayout.astro";
import Navbar from "../components/Navbar.astro";

const CH_USER = "j3dus0r";

async function getJSON(url) {
  try {
    const r = await fetch(url);
    if (!r.ok) return null;
    return await r.json();
  } catch {
    return null;
  }
}

const ch = await getJSON(`https://cryptohack.org/api/user/${CH_USER}/`);

// Traiter les données de l'API
let categoryScores = {};
let recentChallenges = [];

if (ch && ch.solved_challenges) {
  // Grouper par catégorie et calculer les scores
  ch.solved_challenges.forEach(challenge => {
    if (!categoryScores[challenge.category]) {
      categoryScores[challenge.category] = 0;
    }
    categoryScores[challenge.category] += challenge.points;
  });
  
  // Récupérer les 10 derniers challenges (triés par date)
  recentChallenges = [...ch.solved_challenges]
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 10);
}
---

<BaseLayout title="Stats - Mon Portfolio">
  <Navbar />

  <main class="min-h-screen bg-gradient-to-br from-gray-900 via-black to-gray-900 py-12 px-4">
    <div class="max-w-7xl mx-auto">

      <!-- Header -->
      <div class="mb-12">
        <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-blue-500 to-purple-600 mb-4">
          $ ls /Scores
        </h1>
        <p class="text-gray-400 text-lg">My statistics on CTF/Training platform</p>
      </div>

      <!-- Grid des cartes -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- =============== HACKTHEBOX =============== -->
        <div class="group relative bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-sm border border-green-500/30 rounded-2xl p-8 hover:border-green-500/60 transition-all duration-300 hover:shadow-2xl hover:shadow-green-500/20 hover:-translate-y-1">
          <div class="absolute inset-0 bg-gradient-to-br from-green-500/5 to-transparent rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity"></div>

          <div class="relative">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center">
                <svg class="w-7 h-7 text-green-400" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                </svg>
              </div>
              <h2 class="text-3xl font-bold text-green-400">HackTheBox</h2>
            </div>

            <p class="text-gray-300 text-lg mb-6 leading-relaxed">
              HTB API is not publicly accessible, but my profile is still available online.
            </p>

            <a href="https://app.hackthebox.com/users/HTB-C4E9E5D92D"
               target="_blank"
               class="inline-flex items-center gap-2 text-green-400 text-lg font-semibold hover:text-green-300 transition-colors group/link">
              <span>➜ Check my HackTheBox profile</span>
              <svg class="w-5 h-5 group-hover/link:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
              </svg>
            </a>
          </div>
        </div>

        <!-- =============== TRYHACKME =============== -->
        <div class="group relative bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-sm border border-red-500/30 rounded-2xl p-8 hover:border-red-500/60 transition-all duration-300 hover:shadow-2xl hover:shadow-red-500/20 hover:-translate-y-1">
          <div class="absolute inset-0 bg-gradient-to-br from-red-500/5 to-transparent rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity"></div>

          <div class="relative">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center">
                <svg class="w-7 h-7 text-red-400" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <h2 class="text-3xl font-bold text-red-400">TryHackMe</h2>
            </div>

            <div class="mb-6 bg-black/30 rounded-xl p-4 border border-red-500/20">
              <iframe
                src="https://tryhackme.com/api/v2/badges/public-profile?userPublicId=1049624"
                class="w-full h-24 border-none"
                title="TryHackMe Badge">
              </iframe>
            </div>

            <a href="https://tryhackme.com/p/j3dus0r"
               target="_blank"
               class="inline-flex items-center gap-2 text-red-400 text-lg font-semibold hover:text-red-300 transition-colors group/link">
              <span>➜ Check my TryHackMe profile</span>
              <svg class="w-5 h-5 group-hover/link:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
              </svg>
            </a>
          </div>
        </div>

      </div>

      <!-- =============== CRYPTOHACK (Full Width) =============== -->
      <div class="mt-8 group relative bg-gradient-to-br from-gray-800/50 to-gray-900/50 backdrop-blur-sm border border-yellow-500/30 rounded-2xl p-8 hover:border-yellow-500/60 transition-all duration-300 hover:shadow-2xl hover:shadow-yellow-500/20">
        <div class="absolute inset-0 bg-gradient-to-br from-yellow-500/5 to-transparent rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity"></div>

        <div class="relative">
          <div class="flex items-center gap-3 mb-8">
            <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center">
              <svg class="w-7 h-7 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
              </svg>
            </div>
            <h2 class="text-3xl font-bold text-yellow-300">CryptoHack</h2>
            <span class="ml-auto px-3 py-1 bg-green-500/20 text-green-400 text-sm font-semibold rounded-full border border-green-500/30">
              Live API
            </span>
          </div>

          {ch ? (
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

              <!-- Colonne 1: Stats principales -->
              <div class="space-y-4">
                <h3 class="text-xl font-bold text-yellow-300 mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  Statistics
                </h3>

                <div class="space-y-3">
                  <div class="bg-black/30 rounded-lg p-4 border border-yellow-500/20">
                    <p class="text-gray-400 text-sm mb-1">User</p>
                    <p class="text-white text-xl font-bold">{ch.username}</p>
                  </div>

                  <div class="bg-black/30 rounded-lg p-4 border border-yellow-500/20">
                    <p class="text-gray-400 text-sm mb-1">Total score</p>
                    <p class="text-yellow-300 text-2xl font-bold">{ch.score}</p>
                  </div>

                  <div class="bg-black/30 rounded-lg p-4 border border-yellow-500/20">
                    <p class="text-gray-400 text-sm mb-1">Global rank</p>
                    <p class="text-white text-xl font-bold">#{ch.rank}</p>
                  </div>

                  <div class="bg-black/30 rounded-lg p-4 border border-yellow-500/20">
                    <p class="text-gray-400 text-sm mb-1">Solved challenges</p>
                    <p class="text-white text-xl font-bold">{ch.solved_challenges?.length ?? 0}</p>
                  </div>

                  <div class="bg-black/30 rounded-lg p-4 border border-yellow-500/20">
                    <p class="text-gray-400 text-sm mb-1">Level</p>
                    <p class="text-white text-xl font-bold">{ch.level}</p>
                  </div>

                  <div class="bg-black/30 rounded-lg p-4 border border-yellow-500/20">
                    <p class="text-gray-400 text-sm mb-1">First Bloods</p>
                    <p class="text-white text-xl font-bold">{ch.first_bloods}</p>
                  </div>
                </div>
              </div>

              <!-- Colonne 2: Catégories -->
              <div class="space-y-4">
                <h3 class="text-xl font-bold text-yellow-300 mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                  </svg>
                  Categories
                </h3>

                {Object.keys(categoryScores).length > 0 ? (
                  <div class="space-y-2 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                    {Object.entries(categoryScores)
                      .sort((a, b) => b[1] - a[1])
                      .map(([cat, score]) => (
                      <div class="bg-black/30 rounded-lg p-3 border border-yellow-500/20 hover:border-yellow-500/40 transition-colors">
                        <div class="flex justify-between items-center">
                          <span class="text-yellow-200 font-semibold text-sm">{cat}</span>
                          <span class="text-white font-bold">{score}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p class="text-gray-500">No categories available.</p>
                )}
              </div>

              <!-- Colonne 3: Challenges récents -->
              <div class="space-y-4">
                <h3 class="text-xl font-bold text-yellow-300 mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                  </svg>
                  Recent
                </h3>

                {recentChallenges.length > 0 ? (
                  <div class="space-y-2 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                    {recentChallenges.map(r => (
                      <div class="bg-black/30 rounded-lg p-3 border border-yellow-500/20 hover:border-yellow-500/40 transition-colors">
                        <p class="text-white font-bold text-sm mb-1">{r.name}</p>
                        <div class="flex justify-between items-center">
                          <p class="text-gray-400 text-xs">{r.category}</p>
                          <p class="text-yellow-400 text-xs font-semibold">{r.points} pts</p>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p class="text-gray-500">No recent challenge</p>
                )}
              </div>

            </div>
          ) : (
            <div class="text-center py-12">
              <svg class="w-16 h-16 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
              <p class="text-red-400 text-lg font-semibold">⚠ Unable to load CryptoHack data</p>
              <p class="text-gray-400 mt-2">Check your connection or try again later.</p>
            </div>
          )}

        </div>
      </div>

    </div>
  </main>
</BaseLayout>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(234, 179, 8, 0.3);
    border-radius: 3px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(234, 179, 8, 0.5);
  }
</style>